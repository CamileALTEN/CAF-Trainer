############################################################
# CAF-Trainer • backend • Dockerfile.dev (hot-reload)
############################################################
FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=development \
    NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/corp-root-ca.crt

# 1) Certificat interne
COPY backend/corp-root-ca.cer /usr/local/share/ca-certificates/corp-root-ca.crt
RUN cat /usr/local/share/ca-certificates/corp-root-ca.crt >> /etc/ssl/certs/ca-certificates.crt

# 2) Dépendances mono-repo
COPY package*.json ./
COPY backend/package*.json backend/
COPY tsconfig*.json ./
RUN npm ci --workspaces --include-workspace-root=false --workspace backend

# 3) Code complet + génération Prisma
COPY backend ./backend

WORKDIR /app/backend
RUN npx prisma generate

# 4) Hot-reload
WORKDIR /app/backend
RUN npm i -D ts-node-dev
RUN addgroup -g 1001 app && adduser -D -G app -u 1001 app
USER app
CMD ["npm", "run", "dev"]

EXPOSE 5000
